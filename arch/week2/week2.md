# Social Network X - Content

## Резюме
В данном документе приведено дополнение к описанию домена контента социальной сети.

## Терминология
- Пост - это единица контента, которую пользователь создает и публикует на своей странице или в профиле для обмена информацией с другими пользователями. Посты могут включать текст, изображения, видео, ссылки и другие медиаформаты в зависимости от платформы.
- Пользовательская лента (лента) -  это динамическое, обновляющееся пространство, где пользователи получают контент от других пользователей, групп, страниц или аккаунтов, на которые они подписаны.
- Лайк (реакция) - это способ выразить одобрение, поддержку или положительное отношение к контенту, опубликованному другими пользователями.

## Требования к системе
### Функциональные требования к системе
- Работа с пользователями
    - Регистрация и Аутентификация/Авторизация, восстановление пароля
    - Создание профиля, редактирование. Просмотр своего профиля и профиля других
    - Подписки, отписки на людей
    - Сообщения (переписка): написание, редактирование
    - Нотификации: сообщения, новые подписчики
- Работа с контентом
    - Посты: написание, редактирование, удаление, лайки/дизлайки, комментарии
    - Работа с лентой: отображение, ранжирование
    - Поиск по системе: посты, люди
    - Аналитика для пользователя: активность в течение месяца, наиболее популярные посты, люди (с кем чаще общался, кого чаще просматривал) и т.д.

### Нефункциональные требования к системе
- DAU = 30 mln
- MAU = 70 mln
- RPD per user (RPDPU): 60, r/w ratio: 40/20
- Геораспределенность: РФ
- Сезонность: праздники
- Вечная retation policy
- Критична лента, посты умеренно
- Устройства: Mobile & Desktop

### Аналитика
    Peak Multiplier (PM) = 2.5
    Off-Peak Multiplier (OM) = 0.5

    RPS = MAU * RPDPU / 86400 = 20834
    Max-RPS = PM * RPS = 52085
    Min-RPS = OM * RPS = 10417

    RPS-read = RPS / RPDPU * read-ratio = 13889
    Max-RPS-read = PM * RPS-read = 34723
    Min-RPS-read = OM * RPS-read = 6945

    RPS-write = RPS / RPDPU * write-ratio = 6945
    Max-RPS-write = PM * RPS-write = 17363
    Min-RPS-write = OM * RPS-write = 3473

### Архитектура системы

В начале выделим все доменные области системы социальаной сети:
- пользователи (сами пользователи + авторизация и аутентификация)
- чаты
- контент
- аналитика

В данном документе будет рассмотрена верхнеуровневая архитектура домена контента.
В нем будут следующие сервисы:
- сервис поиска
- сервис постов
- сервис по работе с лентой

Контент будет состоять из двух логических частей:
- посты
- лента

Посты в себя могут включать следующее:
- текст
- различные форматы аудио- и видео-контента
- реакции

Исходя из требований, контент ленты будет представлять из себя ранжированный список постов других людей, где на ранг поста может влиять много критериев:
- количество просмотров
- количество лайков (реакций)
- количество комментариев
- различные показатели изменения динамики роста просмотров/лайков/комментариев за определенные промежутки времени (например, скорость)
- социальный ранг автора поста, прореагировавших пользователей и пользователей, написавших комментарий

По дополнениям к системе:
- Хранилище ленты будет разделено по принципу CQRS на две части: read-реплика для сервиса ленты и write-реплика для серверов ранжирования, где read-реплика будет логически синхронизироваться с write-репликой.
- В предыдущей версии архитектуры домена контента хранилище постов использовалось несколькими сервисами, что вносит лишнюю сильную связность разных сервисов системы и делает доступ к хранилищу bottleneck'ом системы. Чтобы от этого отойти, необходимо делать реплики хранилища постов. Реплика базы постов будет на стороне сегмента ленты, реплика обновляется от воркера, который считывает изменения из брокера сообщений. 
- Кроме того, стоит заметить, что посты и действия по ним - краегуольный камень всего домена в целом. В результате CRUD-операций по постам данные могут отправляться и в домен аналитики, и в домен пользователей, и в БД, и в её реплики через очереди. В целях сделать эту комплексную операцию атомарной, будем использовать Transaction Outbox: заведем специальную РСУБД для добавления событий записи и worker-сервис, который будет в зависимости от типа записи испускать те или иные события в брокер сообщений.
- В свою очередь, индексатор тоже не читает данные напрямую из базы, а также из очереди, данные в которую отправляет worker от Transaction Outbox.
- Сам по себе домен ориентирован на AP и EDA.
- Для сервисов поиска и ленты разумно использовать многоуровневый кэш (локальный + общий) с политикой Cache Aside Read + Write, т.к. данные для них поставляются асинхронно другими сервисами и не изменяются пользователями. Для сервиса постов разумно использовать Read & Write Through.

<p align="center">
    <b>Архитектура домена Контента. Уровень С2.</b> Container diagram
</p>

<p align="center">
  <img src="images/C2.svg" />
</p>
