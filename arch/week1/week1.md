# Social Network X - Content

## Резюме
В данном документе приведено описание домена контента социальной сети.

## Терминология
- Пост - это единица контента, которую пользователь создает и публикует на своей странице или в профиле для обмена информацией с другими пользователями. Посты могут включать текст, изображения, видео, ссылки и другие медиаформаты в зависимости от платформы.
- Пользовательская лента (лента) -  это динамическое, обновляющееся пространство, где пользователи получают контент от других пользователей, групп, страниц или аккаунтов, на которые они подписаны.
- Лайк (реакция) - это способ выразить одобрение, поддержку или положительное отношение к контенту, опубликованному другими пользователями.

## Требования к системе
### Функциональные требования к системе
- Работа с пользователями
    - Регистрация и Аутентификация/Авторизация, восстановление пароля
    - Создание профиля, редактирование. Просмотр своего профиля и профиля других
    - Подписки, отписки на людей
    - Сообщения (переписка): написание, редактирование
    - Нотификации: сообщения, новые подписчики
- Работа с контентом
    - Посты: написание, редактирование, удаление, лайки/дизлайки, комментарии
    - Работа с лентой: отображение, ранжирование
    - Поиск по системе: посты, люди
    - Аналитика для пользователя: активность в течение месяца, наиболее популярные посты, люди (с кем чаще общался, кого чаще просматривал) и т.д.

### Нефункциональные требования к системе
- DAU = 30 mln
- MAU = 70 mln
- RPD per user (RPDPU): 60, r/w ratio: 40/20
- Геораспределенность: РФ
- Сезонность: праздники
- Вечная retation policy
- Критична лента, посты умеренно
- Устройства: Mobile & Desktop

### Аналитика
    Peak Multiplier (PM) = 2.5
    Off-Peak Multiplier (OM) = 0.5

    RPS = MAU * RPDPU / 86400 = 20834
    Max-RPS = PM * RPS = 52085
    Min-RPS = OM * RPS = 10417

    RPS-read = RPS / RPDPU * read-ratio = 13889
    Max-RPS-read = PM * RPS-read = 34723
    Min-RPS-read = OM * RPS-read = 6945

    RPS-write = RPS / RPDPU * write-ratio = 6945
    Max-RPS-write = PM * RPS-write = 17363
    Min-RPS-write = OM * RPS-write = 3473

### Архитектура системы

В начале выделим все доменные области системы социальаной сети:
- пользователи (сами пользователи + авторизация и аутентификация)
- чаты
- контент
- аналитика

В данном документе будет рассмотрена верхнеуровневая архитектура домена контента.
В нем будут следующие сервисы:
- сервис поиска
- сервис постов
- сервис по работе с лентой

Контент будет состоять из двух логических частей:
- посты
- лента

Посты в себя могут включать следующее:
- текст
- различные форматы аудио- и видео-контента
- реакции

Исходя из требований, контент ленты будет представлять из себя ранжированный список постов других людей, где на ранг поста может влиять много критериев:
- количество просмотров
- количество лайков (реакций)
- количество комментариев
- различные показатели изменения динамики роста просмотров/лайков/комментариев за определенные промежутки времени (например, скорость)
- социальный ранг автора поста, прореагировавших пользователей и пользователей, написавших комментарий

О системе:
- на входе в систему будет стоять LB уровня L4 для распределения трафика запросов по нескольким API GW, выбор будет осуществляться на основе 5-tuple, также на входе будет стоять стандартный rate-limiter на 50% от Max-RPS.
- в системе будет несколько API GW для распределения нагрузки, у всех будет некоторый rate-limiter.
Алгоритм работы rate-limiter будет гибридным: весь трафик поделим на критичный (20%) и некритичный(80%). Весь критичный трафик будет маршрутизироваться на сервис по работе с лентой. В свою очередь некритичный трафик - на операции с постами и поиск по ним. Для некритичного трафика будем вести управление нагрузкой с учётом утилизации воркеров (в зависимости от загрузки определенные типы запросов будут отбрасываться c ошибкой 503 - Service Unavailable), далее приведе список от самых приоритетных запросов к менее приоритетным: 
    - методы по работе с лентой;
    - методы по написанию/редактированию постов;
    - методы по обработке реакций/комментариев к постам;
    - методы по поиску по постам;
    - все остальное.
Особые алгоритмы балансировки не нужны, API GWs лишь перенаправляют трафик на LB нужных кластеров.
- для сервисов ленты будет LB L7 балансировщик для того, чтобы использовать кеширование ленты на рабочих серверах, поэтому в наших интересах, чтобы алгоритм балансировки обладал sticky sessions. В таком случае разумно будет избрать вариант с хеширующим алгоритмом балансировки;
- для сервисов поиска ситуация схожа с сервисами ленты;
- для сервисов постов будет LB L4 балансировщик на основе 5-tuple, сам же сервис постов будет отправлять необходимые данные по комментариям и реакциям в домен Аналитики, а различные события, связанные с пользователями - в домен Пользователей, который в дальнейшем обработает их в качестве уведомлений;
- сервисы ленты будут обращаться к заранее заготовленной БД Postgres с подготовленными отранжированными постами и кешировать у себя промежуточные результаты;
- все медиафайлы будут храниться в одном распределенном неструктурированном хранилище;
- для ранжирования постов будет выделен отдельный ранжирующий кластер серверов, который с определенным периодом проводит реранжирование постов с учетом появившихся, беря часть параметров из баз данных домена, за другими же обращается в домен Аналитики;
Для описания реализации системы будет использована нотация C4 и представлен уровень С2.

<p align="center">
    <b>Архитектура домена Контента. Уровень С2.</b> Container diagram
</p>

<p align="center">
  <img src="images/C2.svg" />
</p>